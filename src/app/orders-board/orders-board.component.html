<div class="orders-page">

  <!-- Header -->
  <div class="header">
    <div>
      <h1>Orderly Print</h1>
      <p *ngIf="!loading">{{ orders.length }} orders loaded</p>
      <p *ngIf="loading">Loading orders…</p>
      <p *ngIf="error" class="error">{{ error }}</p>
    </div>
    <button class="btn primary" (click)="fetch()" [disabled]="loading">
      {{ loading ? 'Loading…' : 'Fetch orders' }}
    </button>
  </div>

  <!-- Filters -->
  <div class="filters">
    <select>
      <option>Status: Any</option>
      <option>Status: Open</option>
      <option>Status: Closed</option>
    </select>
    <select>
      <option>Payment: Any</option>
      <option>Paid</option>
      <option>Pending</option>
    </select>
    <select>
      <option>Fulfillment: Any</option>
      <option>Unfulfilled</option>
      <option>Fulfilled</option>
    </select>
    <input type="date" />
    <label>
      <input type="checkbox" /> Hide complete
    </label>

    <td colspan="6" class="num"><strong>Grand Total</strong></td>
    <td class="num">
      <ng-container *ngIf="totalsCurrency; else plainGrand">
        {{ grandTotal | currency:totalsCurrency:'symbol' }}
      </ng-container>
      <ng-template #plainGrand>
        {{ grandTotal | number:'1.0-2' }} {{ totalsCurrency || '' }}
      </ng-template>
    </td>
  </div>

  <!-- quick shipday export controls -->
  <input [(ngModel)]="exportShop" placeholder="shop domain" />
  <input type="date" [(ngModel)]="exportDate" />
  <button (click)="exportShipday()">Export Shipday CSV</button>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="actions-left">
      <button class="btn">Picking list</button>
      <button class="btn">Packing slips</button>
      <button class="btn">Invoices</button>
      <button class="btn">Labels</button>
    </div>
    <div class="actions-right">
      <button class="btn success">Fulfill</button>
      <button class="btn info">Export</button>
      <button class="btn danger">Archive</button>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="card table-wrapper" *ngIf="!loading && orders?.length">
    <table>
      <thead>
        <tr>
          <th>Order</th>
          <th>Tags</th>
          <th>Products</th>
          <th>Shipping Info</th>
          <th>Method / Notes</th>
          <th>Total</th>
          <th>Code Used</th>
          <th>Source</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let o of orders">
          <!-- Order -->
          <td [ngStyle]="{ 'color': isExpress(o) ? 'red' : '' }">
            <div class="order-id">
              <div class="link" [ngStyle]="{ 'color': isExpress(o) ? 'red' : '' }">
                {{ o.orderName || o.orderId }}
              </div>
              <div class="customer">{{ o.shipTo?.name }}</div>
              <div class="date">{{ o.createdAt | date:'medium' }}</div>
              <div class="badges">
                <span class="badge open">{{ o.fulfillmentStatus || 'Open' }}</span>
                <span class="badge" [ngClass]="(o.financialStatus||'').toLowerCase()">
                  {{ o.financialStatus }}
                </span>
              </div>
            </div>
          </td>

          <!-- Tags -->
          <!-- <td [ngStyle]="{ 'color': isExpress(o) ? 'red' : '' }">
            <div class="badges">
              <span *ngFor="let t of getTags(o.tags)" class="tag" [ngClass]="t.toLowerCase()">
                {{ t }}
              </span>
            </div>
            <select (change)="onTagChange(o, $event)">
              <option value="">Add tag</option>
              <option>Complete</option>
              <option>Processing</option>
              <option>Shipped</option>
              <option>Cancel</option>
            </select>
          </td> -->
          <td>
            <div class="badges">
              <span *ngFor="let t of o.tags"
                    class="tag" [ngClass]="t.toLowerCase()">
                {{ t }}
                <button class="tag-x" (click)="removeTag(o, t)" title="Remove">×</button>
              </span>
            </div>
          
            <select (change)="onNextAction(o, $event)">
              <option value="">Add tag</option>
              <option *ngFor="let opt of nextActions(o)" [value]="opt">{{ opt }}</option>
            </select>
          </td>

          <!-- Products (qty × unit = line total) -->
          <td [ngStyle]="{ 'color': isExpress(o) ? 'red' : '' }">
            <div *ngFor="let p of (o.items || [])" class="product-line">
              <!-- <img *ngIf="p.IMAGE" [src]="p.IMAGE" alt="" class="thumb" loading="lazy" /> -->
              <ng-container *ngIf="p.IMAGE; else noImg">
                <img [src]="p.IMAGE" alt="" class="thumb" loading="lazy" />
              </ng-container>
              <ng-template #noImg>
                <div class="thumb thumb--blank"></div>
              </ng-template>
              
              <div class="product-text">
                <span class="product-name">{{ p.TITLE }}</span>
                <span *ngIf="p.VARIANT_TITLE" class="muted">({{ p.VARIANT_TITLE }})</span>
                <span class="muted">x{{ p.QUANTITY }}</span>
          
                <div class="muted">
                  <ng-container *ngIf="o.currency; else plainPrices">
                    {{ (p.UNIT_PRICE ?? 0) | currency:o.currency:'symbol' }} × {{ p.QUANTITY }} =
                    {{ (p.LINE_TOTAL ?? (p.UNIT_PRICE ?? 0) * p.QUANTITY) | currency:o.currency:'symbol' }}
                  </ng-container>
                  <ng-template #plainPrices>
                    {{ (p.UNIT_PRICE ?? 0) | number:'1.2-2' }} × {{ p.QUANTITY }} =
                    {{ (p.LINE_TOTAL ?? (p.UNIT_PRICE ?? 0) * p.QUANTITY) | number:'1.2-2' }}
                    {{ p.CURRENCY || o.currency || '' }}
                  </ng-template>
                </div>
          
                <!-- LINE-ITEM PROPERTIES (optional) -->
                <div class="muted" *ngFor="let prop of parseProps(p.PROPERTIES_JSON)">
                  • {{ prop.name }}: {{ prop.value }}
                </div>
              </div>
            </div>
          </td>
          

          <!-- Shipping Info -->
          <td [ngStyle]="{ 'color': isExpress(o) ? 'red' : '' }">
            
            <div class="muted">{{ o.shipTo?.phone }}</div>
            <div class="muted">
              {{ o.shipTo?.address1 }}
              <span *ngIf="o.shipTo?.address2">, {{ o.shipTo?.address2 }}</span>
            </div>
            <div class="muted">
              {{ o.shipTo?.city }} {{ o.shipTo?.zip }}
            </div>
            <div class="muted">
              {{ o.shipTo?.province }} {{ o.shipTo?.country }}
            </div>
          </td>

          <!-- Method / Notes -->
          <td [ngClass]="{ 'text-express': isExpress(o), 'text-old': isOld(o) }"
    [ngStyle]="{ 'color': isExpress(o) ? 'red' : '' }">
  {{ o.shippingMethod || '—' }}
  <!-- <span *ngIf="isExpress(o)" class="ship ship-express">Express</span> -->
  <span *ngIf="isOld(o)" class="ship ship-old">OLD ORDER</span>

  <!-- ORDER NOTE (plain text) -->
  <div class="muted prewrap" *ngIf="o.note" style="margin-top:6px;">
    {{ o.note }}
  </div>

  <!-- NOTE ATTRIBUTES -->
  <ul class="muted" *ngIf="o.noteAttributes?.length" style="margin:6px 0 0 0; padding-left:18px;">
    <li *ngFor="let a of o.noteAttributes">
      {{ a.name }}: {{ a.value }}
    </li>
  </ul>
</td>


          <!-- Total (order-level) -->
          <td class="num">
            <ng-container *ngIf="o.currency; else plainTotal">
              <b>{{ (o.total || 0) | currency:o.currency:'symbol' }}</b>
            </ng-container>
            <ng-template #plainTotal>
              {{ o.total || 0 | number:'1.0-2' }} {{ o.currency || '' }}
            </ng-template>
          </td>
          
          <!-- Code Used -->
          <td class="muted">
            <ng-container *ngIf="o.discountCodes && o.discountCodes.length > 0; else dash">
              {{ o.discountCodes.join(', ') }}
            </ng-container>
            <ng-template #dash>—</ng-template>
          </td>
          

          <!-- Source -->
          <td class="muted">{{ o.sourceName || '—' }}</td>

        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!loading && !orders?.length" class="empty">
    No orders yet.
  </div>
</div>
